# L7.1: Linux Scheduling Classes - Real-Time Audio Priority

**Unit 7: Real-Time Audio Constraints**  
**Estimated Time:** 75-90 minutes  
**Competence Target:** Level 5 (Synthesis - can configure real-time systems)

---

## Learning Objectives

By the end of this lesson, you will:

1. **Understand** Linux scheduling classes (SCHED_OTHER, SCHED_FIFO, SCHED_RR)
2. **Explain** why audio threads need real-time priority
3. **Measure** latency improvement with `chrt`
4. **Configure** `/etc/security/limits.conf` for real-time permissions
5. **Debug** "Operation not permitted" errors
6. **Analyze** when NOT to use real-time priority

---

## The Mystery: Why Audio Glitches Despite 60 FPS?

### Your Current Situation

**Your game runs at perfect 60 FPS, but audio still has clicks.**

```c
// backend.c - Main loop runs smoothly
while (running) {
  // Frame time: 16.6ms consistently
  GameUpdate();
  GameRender();
  GameOutputSound();  // Sometimes takes 25ms!? Why?
}
```

**Problem:** Your process gets preempted by other system tasks.

---

## Concept 1: Linux Scheduling Classes

### The CPU Time-Sharing Model

**Linux scheduler decides who runs when:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    100 processes want CPU time    ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ  - Your game (audio thread)        ‚îÇ
‚îÇ  - Chrome (50 tabs)                ‚îÇ
‚îÇ  - System services (cron, systemd) ‚îÇ
‚îÇ  - Background updates              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì Linux Scheduler ‚Üì
    Who runs next? How long?
```

**Problem:** By default, ALL processes are treated equally!

---

### Three Scheduling Classes

| Class | Priority | Preemption | Use Case |
|-------|----------|------------|----------|
| **SCHED_OTHER** | 0 (nice -20 to 19) | Can be preempted anytime | Desktop apps, browsers |
| **SCHED_FIFO** | 1-99 | Only preempted by higher RT | Audio, video capture |
| **SCHED_RR** | 1-99 | Time-sliced among same priority | Multiple RT threads |

---

###

 SCHED_OTHER (Default - Your Current Mode)

**How it works:**
- Uses "Completely Fair Scheduler" (CFS)
- Tries to give everyone equal CPU time
- Can be interrupted ("preempted") by ANY other process

**Example timeline:**
```
Time:   0ms    5ms   10ms  15ms  20ms  25ms  30ms
Game:   [RUN] [---] [RUN] [RUN] [---] [---] [RUN]
                ‚Üë           ‚Üë      ‚Üë
           Preempted by: Chrome, system daemon, kernel task
```

**Result:** Audio callback takes 30ms instead of 16ms ‚Üí underrun ‚Üí click!

---

### SCHED_FIFO (Real-Time Priority)

**How it works:**
- Fixed priority (1-99, higher = more important)
- Runs until it voluntarily yields (sleeps, I/O wait)
- Cannot be preempted by lower-priority processes

**Same timeline with priority 10:**
```
Time:   0ms    5ms   10ms  15ms  20ms  25ms  30ms
Game:   [RUN] [RUN] [RUN] [---] [RUN] [RUN] [RUN]
                           ‚Üë
                      Only yields when
                      sleeps (frame wait)
```

**Result:** Audio callback completes in 16ms consistently ‚Üí no clicks!

---

### Web Dev Analogy

**SCHED_OTHER:**
```javascript
// Your code is in setTimeout queue with everything else
setTimeout(() => fillAudioBuffer(), 0);  // Might run in 1ms or 50ms!
```

**SCHED_FIFO:**
```javascript
// Your code runs in microtask queue (higher priority)
Promise.resolve().then(() => fillAudioBuffer());  // Runs ASAP
```

---

## Exercise 1: See Scheduling in Action

### Step 1: Check Current Scheduling

```bash
# What class is your game using?
ps -eo pid,class,rtprio,comm | grep game

# Output:
# PID  CLS RTPRIO CMD
# 1234  TS     -   game

# TS = Time-Sharing (SCHED_OTHER)
# RTPRIO = - (no real-time priority)
```

---

### Step 2: Run with Real-Time Priority

```bash
# Run game with SCHED_FIFO priority 10
sudo chrt -f 10 ./game

# Or check while running:
ps -eo pid,class,rtprio,comm | grep game

# Output:
# PID  CLS RTPRIO CMD
# 5678  FF    10   game

# FF = FIFO (SCHED_FIFO)
# RTPRIO = 10
```

**Listen:** Audio should be smoother, fewer clicks!

---

### Step 3: Measure Latency Difference

**Add to your audio code:**
```c
void GameOutputSound(GameSoundOutput *sound_buffer) {
  struct timespec start, end;
  clock_gettime(CLOCK_MONOTONIC, &start);
  
  // Fill audio buffer...
  
  clock_gettime(CLOCK_MONOTONIC, &end);
  
  int64_t elapsed_us = (end.tv_sec - start.tv_sec) * 1000000LL +
                       (end.tv_nsec - start.tv_nsec) / 1000LL;
  
  static int64_t max_latency = 0;
  static int64_t min_latency = 999999;
  
  if (elapsed_us > max_latency) max_latency = elapsed_us;
  if (elapsed_us < min_latency) min_latency = elapsed_us;
  
  static int frame_count = 0;
  if (++frame_count % 600 == 0) {  // Every 10 seconds @ 60 FPS
    printf("Audio callback: min=%lld Œºs, max=%lld Œºs\n", 
           min_latency, max_latency);
    max_latency = 0;
    min_latency = 999999;
  }
}
```

**Results:**

| Mode | Min Latency | Max Latency | Jitter |
|------|-------------|-------------|--------|
| **SCHED_OTHER** | 150 Œºs | 25,000 Œºs | 24,850 Œºs |
| **SCHED_FIFO (10)** | 150 Œºs | 3,000 Œºs | 2,850 Œºs |

**Jitter reduced by 90%!** üéâ

---

## Concept 2: Real-Time Permissions

### The "Operation not permitted" Error

**Try this:**
```bash
chrt -f 10 ./game
# chrt: failed to set pid 0's policy: Operation not permitted
```

**Why:** Normal users can't set real-time priority (security risk).

---

### Solution 1: Run as Root (NOT RECOMMENDED)

```bash
sudo chrt -f 10 ./game  # Works, but dangerous
```

**Problems:**
- Your game runs as root (security hole!)
- Can crash the system if buggy
- Can't distribute to users this way

---

### Solution 2: Grant Capability (Better)

```bash
# Give your binary permission to set real-time priority
sudo setcap cap_sys_nice=eip ./game

# Verify:
getcap ./game
# Output: ./game = cap_sys_nice+eip

# Now works without sudo:
chrt -f 10 ./game
```

**Limitation:** Only for this specific binary (recompile = lose permission).

---

### Solution 3: Configure limits.conf (Best for Development)

**Edit `/etc/security/limits.conf`:**
```bash
sudo nano /etc/security/limits.conf
```

**Add these lines:**
```
# Allow your user to set real-time priority
yourusername    -    rtprio    99
yourusername    -    nice      -20
```

**Logout and login again, then:**
```bash
# No sudo needed!
chrt -f 10 ./game
```

**Verify:**
```bash
ulimit -r
# Output: 99 (max real-time priority allowed)
```

---

## Exercise 2: Configure Your System

**Step-by-step:**

1. **Add limits:**
   ```bash
   echo "$USER    -    rtprio    99" | sudo tee -a /etc/security/limits.conf
   ```

2. **Logout/login** (or reboot)

3. **Verify:**
   ```bash
   ulimit -r
   # Should show: 99
   ```

4. **Test:**
   ```bash
   chrt -f 10 ./game
   # Should work without sudo!
   ```

---

## Concept 3: When NOT to Use Real-Time Priority

### Danger Zone: Runaway Real-Time Thread

**Bad code:**
```c
// NEVER DO THIS:
int main() {
  struct sched_param param = { .sched_priority = 99 };
  pthread_setschedparam(pthread_self(), SCHED_FIFO, &param);
  
  while (1) {
    // Infinite loop at max priority!
    // System becomes unresponsive!
  }
}
```

**Result:** System freeze! SSH won't even work! Must hard reboot!

---

### Safe Patterns

**‚úÖ DO:**
- Use priority 10-20 for audio (leave headroom)
- Always have sleep/yield in RT loop
- Test without RT first, add RT later
- Log when RT thread starts/stops

**‚ùå DON'T:**
- Use priority > 50 (kernel uses 50-99)
- Use RT for CPU-bound loops
- Forget to yield/sleep
- Use RT for debug/logging code

---

## Exercise 3: Set Priority from Code

**Instead of `chrt` command-line, set from within your program:**

```c
#include <sched.h>
#include <pthread.h>

int LinuxSetThreadRealtime(int priority) {
  struct sched_param param = {
    .sched_priority = priority  // 1-99
  };
  
  int result = sched_setscheduler(0, SCHED_FIFO, &param);
  
  if (result == -1) {
    perror("sched_setscheduler");
    fprintf(stderr, "Failed to set real-time priority %d\n", priority);
    fprintf(stderr, "Run with: sudo setcap cap_sys_nice=eip ./game\n");
    return -1;
  }
  
  printf("‚úÖ Set real-time priority: SCHED_FIFO %d\n", priority);
  return 0;
}

int main() {
  // Try to set RT priority (gracefully fail if not permitted)
  if (LinuxSetThreadRealtime(10) != 0) {
    printf("‚ö†Ô∏è  Running without real-time priority (audio may glitch)\n");
    // Continue anyway!
  }
  
  LinuxMainLoop();
}
```

**Test:**
```bash
# Without permission:
./game
# Output: ‚ö†Ô∏è Running without real-time priority

# With permission:
sudo setcap cap_sys_nice=eip ./game
./game
# Output: ‚úÖ Set real-time priority: SCHED_FIFO 10
```

---

## Concept 4: Priority Levels Guide

### Recommended Priorities

| Priority | Use Case | Preempts |
|----------|----------|----------|
| **1-9** | Background audio processing | Only SCHED_OTHER |
| **10-20** | Game audio (recommended) | Lower RT, all normal |
| **21-49** | System critical (avoid!) | Most processes |
| **50-99** | Kernel threads (NEVER USE!) | Everything |

**Rule:** Use the **lowest priority that works** for your needs.

---

### Priority Math

**Your game priority: 10**
**Another app priority: 15**

```
Timeline:
  0ms: Game starts audio callback (priority 10)
  5ms: Other app wants CPU (priority 15)
       ‚Üí Game is preempted (lower priority)
 10ms: Other app finishes
       ‚Üí Game resumes
```

**Solution:** If another app needs 15, use 16 for your game (but think: do you REALLY need to preempt it?).

---

## Self-Check Quiz

### Question 1
**What scheduling class does your game use by default?**

A) SCHED_FIFO  
B) SCHED_RR  
C) SCHED_OTHER  
D) SCHED_DEADLINE  

<details>
<summary>Answer</summary>

**C) SCHED_OTHER**

All normal desktop applications use SCHED_OTHER (also called SCHED_NORMAL). This is the default Completely Fair Scheduler (CFS).
</details>

---

### Question 2
**What happens if a SCHED_FIFO thread has infinite loop?**

A) Kernel kills it  
B) System becomes unresponsive  
C) Switches to SCHED_OTHER automatically  
D) Other threads run in parallel  

<details>
<summary>Answer</summary>

**B) System becomes unresponsive**

SCHED_FIFO threads run until they yield. An infinite loop at high priority will starve all lower-priority processes, including SSH and terminals!
</details>

---

### Question 3
**Why does `chrt -f 10 ./game` fail for normal users?**

A) Syntax error  
B) Missing CAP_SYS_NICE capability  
C) Game not compiled with -lrt  
D) Priority 10 is too high  

<details>
<summary>Answer</summary>

**B) Missing CAP_SYS_NICE capability**

Normal users lack permission to set real-time priorities (security measure). Fix with `setcap` or `/etc/security/limits.conf`.
</details>

---

### Question 4
**What priority should game audio use?**

A) 1-9 (low RT)  
B) 10-20 (medium RT)  
C) 50-99 (high RT)  
D) 0 (SCHED_OTHER)  

<details>
<summary>Answer</summary>

**B) 10-20 (medium RT)**

This range works for most game audio needs. Lower priorities (1-9) might not prevent all glitches. Higher priorities (50+) risk system instability.
</details>

---

### Question 5
**What's the difference between SCHED_FIFO and SCHED_RR?**

A) No difference  
B) SCHED_RR time-slices among same priority  
C) SCHED_FIFO is faster  
D) SCHED_RR is for multi-core only  

<details>
<summary>Answer</summary>

**B) SCHED_RR time-slices among same priority**

- SCHED_FIFO: Runs until it yields (no time limit)
- SCHED_RR: Runs for time quantum, then rotates to next same-priority thread

For single audio thread, FIFO is simpler.
</details>

---

## Key Takeaways

### Scheduling Classes Comparison

| Aspect | SCHED_OTHER | SCHED_FIFO |
|--------|-------------|------------|
| **Preemption** | Anytime | Only by higher RT |
| **Priority** | nice -20 to 19 | 1-99 |
| **Use Case** | Desktop apps | Audio, video |
| **Latency** | Variable (50-500ms) | Predictable (< 1ms) |
| **Danger** | None | Can freeze system |

---

### Command Cheat Sheet

```bash
# Check current scheduling
ps -eo pid,class,rtprio,comm

# Run with real-time priority
sudo chrt -f 10 ./game

# Grant capability (per-binary)
sudo setcap cap_sys_nice=eip ./game

# Check limits
ulimit -r

# Configure limits (edit this file)
sudo nano /etc/security/limits.conf
# Add: yourusername - rtprio 99
```

---

### Code Template

```c
#include <sched.h>

int SetRealtimePriority(int priority) {
  struct sched_param param = { .sched_priority = priority };
  if (sched_setscheduler(0, SCHED_FIFO, &param) == -1) {
    perror("Failed to set RT priority");
    return -1;
  }
  return 0;
}

int main() {
  SetRealtimePriority(10);  // Gracefully fails if not permitted
  // ... rest of program
}
```

---

## Connection to Other Lessons

**Prerequisites:**
- L3.5: Adaptive FPS (why timing matters)
- L4.4: Click Detector (measuring audio quality)

**Enables:**
- L7.2: CPU Affinity (combine RT + pinning)
- L7.3: Priority Inversion (RT pitfalls)
- L8.1: Performance Profiling (RT makes profiling easier)

---

## Next Lesson Preview

**L7.2: CPU Affinity & Cache Effects**
- Pin audio thread to single core
- Reduce cache misses
- Measure jitter reduction
- Use `taskset` command

**Teaser:**
```bash
taskset -c 0 chrt -f 10 ./game
# Core 0 + RT priority = ultimate smoothness!
```

---

**Estimated Completion Time:** 75-90 minutes  
**Difficulty:** ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ (Advanced)  
**Competence Level Achieved:** 5/6 (Synthesis)

**Progress:** Unit 7 is 33% complete! (1/3 lessons done)

