# L6.4: Architecture Tradeoff Analysis - Choosing the Right Backend

**Unit 6: Porting & Alternative Backends**  
**Estimated Time:** 45-60 minutes  
**Competence Target:** Level 6 (Evaluation - justify architectural decisions)

---

## Learning Objectives

By the end of this lesson, you will:

1. **Evaluate** audio backend choices using decision matrices
2. **Justify** tradeoffs between latency, complexity, and portability
3. **Design** multi-backend support strategies
4. **Predict** long-term maintenance costs
5. **Critique** your own audio architecture choices
6. **Communicate** technical decisions to stakeholders

---

## The Tradeoff Triangle

```
         Low Latency
            /\
           /  \
          /    \
         /      \
        /        \
       /  ALSA    \
      /            \
     /   PulseAudio \
    /                \
   /  Web Audio       \
  /____________________ \
Simple Code         Cross-Platform

Pick any TWO:
- Low latency + Simple code = Platform-specific
- Simple code + Cross-platform = Higher latency
- Low latency + Cross-platform = Complex abstraction
```

**You cannot have all three!**

---

## Decision Framework

### Project Requirements Checklist

**Rate each (1-5, 5=critical):**

| Requirement | Weight | Notes |
|------------|--------|-------|
| **Latency < 20ms** | __ | Pro audio, rhythm games |
| **Latency < 50ms** | __ | Action games, UI feedback |
| **Latency < 200ms** | __ | Turn-based, background music |
| **Cross-platform** | __ | Desktop (Win/Mac/Linux) |
| **Web deployment** | __ | Browser-based |
| **Mobile (iOS/Android)** | __ | Native apps |
| **Code simplicity** | __ | Small team, limited resources |
| **Minimal dependencies** | __ | Embedded, security-critical |
| **Multi-app mixing** | __ | Desktop app, background music |
| **3D audio/HRTF** | __ | VR, immersive games |

---

## Decision Matrix

### Scoring System

**Score = Σ (Requirement Weight × Backend Score)**

**Backend scores (1-5):**

| Backend | Latency | Simplicity | Cross-Platform | Mixing | 3D Audio |
|---------|---------|-----------|---------------|--------|----------|
| **ALSA** | 5 | 2 | 1 | 1 | 2 |
| **PulseAudio** | 3 | 4 | 2 | 5 | 2 |
| **JACK** | 5 | 2 | 2 | 5 | 3 |
| **CoreAudio** | 4 | 3 | 1 | 4 | 4 |
| **WASAPI** | 4 | 2 | 1 | 4 | 3 |
| **Web Audio** | 3 | 5 | 5 | 5 | 5 |
| **SDL2 Audio** | 3 | 4 | 5 | 4 | 1 |
| **OpenAL** | 3 | 3 | 5 | 4 | 5 |

---

### Example 1: Handmade Hero (Your Project)

**Requirements:**
- Latency < 50ms: Weight 4
- Cross-platform: Weight 1 (Linux only)
- Simplicity: Weight 2
- Dependencies: Weight 3 (minimal)

**ALSA Score:**
```
= (4 × 5) + (1 × 1) + (2 × 2) + (3 × 5)
= 20 + 1 + 4 + 15
= 40
```

**PulseAudio Score:**
```
= (4 × 3) + (1 × 2) + (2 × 4) + (3 × 3)
= 12 + 2 + 8 + 9
= 31
```

**SDL2 Score:**
```
= (4 × 3) + (1 × 5) + (2 × 4) + (3 × 3)
= 12 + 5 + 8 + 9
= 34
```

**Winner: ALSA (40 points)** ✅ Matches your choice!

---

### Example 2: Cross-Platform Indie Game

**Requirements:**
- Latency < 50ms: Weight 3
- Cross-platform: Weight 5 (Win/Mac/Linux)
- Simplicity: Weight 4
- Mobile: Weight 5 (iOS/Android)

**SDL2 Score:**
```
= (3 × 3) + (5 × 5) + (4 × 4) + (5 × 4)
= 9 + 25 + 16 + 20
= 70
```

**OpenAL Score:**
```
= (3 × 3) + (5 × 5) + (4 × 3) + (5 × 4)
= 9 + 25 + 12 + 20
= 66
```

**Winner: SDL2 (70 points)**

---

### Example 3: VR Music Visualizer

**Requirements:**
- Latency < 20ms: Weight 5
- 3D audio: Weight 5
- Cross-platform: Weight 3

**OpenAL Score:**
```
= (5 × 3) + (5 × 5) + (3 × 5)
= 15 + 25 + 15
= 55
```

**Web Audio Score:**
```
= (5 × 3) + (5 × 5) + (3 × 5)
= 15 + 25 + 15
= 55
```

**Tie!** Choose based on deployment (native vs web).

---

## Long-Term Maintenance Costs

### Code Complexity Over Time

| Backend | Initial LOC | 1 Year Later | 3 Years Later | Maintenance Cost |
|---------|-----------|-------------|--------------|-----------------|
| **ALSA** | 300 | 350 | 400 | Medium (kernel changes) |
| **PulseAudio** | 60 | 80 | 100 | Low (stable API) |
| **Web Audio** | 40 | 60 | 80 | Low (browser handles updates) |
| **SDL2** | 100 | 120 | 150 | Low (library maintained) |
| **Custom abstraction** | 500 | 800 | 1200 | High (test all platforms) |

**Rule:** Use libraries unless you have specific needs.

---

## Multi-Backend Strategy

### Option 1: Compile-Time Selection

```c
#ifdef USE_ALSA
  #include "audio_alsa.h"
#elif USE_PULSE
  #include "audio_pulse.h"
#elif USE_WEB
  #include "audio_web.h"
#endif
```

**Pros:** Simple, minimal overhead  
**Cons:** Must recompile for each platform

---

### Option 2: Runtime Selection

```c
typedef struct AudioBackend {
  int (*init)(int sample_rate);
  void (*write)(void *samples, int count);
  void (*shutdown)();
} AudioBackend;

AudioBackend *DetectBackend() {
  if (FileExists("/usr/lib/libasound.so")) {
    return &alsa_backend;
  } else if (FileExists("/usr/lib/libpulse.so")) {
    return &pulse_backend;
  }
  return NULL;
}
```

**Pros:** One binary for all backends  
**Cons:** More complex, larger binary

---

### Option 3: Use Abstraction Library (Recommended)

```c
#include <SDL2/SDL_audio.h>

SDL_AudioSpec spec = {
  .freq = 48000,
  .format = AUDIO_S16SYS,
  .channels = 2,
  .samples = 4096,
  .callback = MyAudioCallback
};

SDL_AudioDeviceID device = SDL_OpenAudioDevice(NULL, 0, &spec, NULL, 0);
```

**Pros:** Cross-platform, maintained by community  
**Cons:** Less control, potential bloat

**Verdict:** Use SDL2 unless you need < 10ms latency or minimal binary size.

---

## Real-World Case Studies

### Case Study 1: Discord (Voice Chat)

**Requirements:**
- Latency < 30ms (real-time voice)
- Cross-platform (Win/Mac/Linux/iOS/Android/Web)
- High quality (Opus codec)

**Choice:** Custom WebRTC + platform-specific backends  
**Why:** No single library met all needs  
**Cost:** Large team, years of development

---

### Case Study 2: Celeste (Indie Game)

**Requirements:**
- Cross-platform (Win/Mac/Linux/Switch)
- Music + SFX mixing
- Simplicity (small team)

**Choice:** FMOD (commercial audio middleware)  
**Why:** Complete solution, supports all platforms  
**Cost:** Licensing fees, acceptable tradeoff

---

### Case Study 3: Audacity (Audio Editor)

**Requirements:**
- Low latency (< 10ms)
- Multi-platform
- Open source

**Choice:** PortAudio library  
**Why:** Wraps ALSA/CoreAudio/WASAPI/JACK  
**Result:** Works everywhere, active development

---

## Exercise: Evaluate Your Choices

**Fill this out for YOUR project:**

### Requirements (1-5)
- Latency target: _______
- Cross-platform: _______
- Code simplicity: _______
- Team size: _______
- Budget: _______

### Backend scores
Calculate for ALSA, PulseAudio, SDL2, Web Audio.

### Winner
Based on scores: _______

### Justification
Write 3-5 sentences explaining your choice.

---

## Communication Template

**When explaining to stakeholders:**

> We chose **[BACKEND]** because:
> 1. It meets our latency requirement of **[XX]ms** (measured: **[YY]ms**)
> 2. It supports **[PLATFORMS]** with **[LOC]** lines of code
> 3. It has **[DEPENDENCY COUNT]** dependencies (vs **[ALTERNATIVE]**'s **[COUNT]**)
> 4. Long-term maintenance is **[LOW/MEDIUM/HIGH]** (API stability, community support)
> 5. Tradeoff: We sacrifice **[X]** to gain **[Y]**

**Example:**
> We chose **ALSA** because:
> 1. It meets our latency requirement of **< 50ms** (measured: **33ms**)
> 2. It supports **Linux** (our only target) with **300** lines of code
> 3. It has **1** dependency (libasound.so, pre-installed) vs SDL2's 3-5 dependencies
> 4. Long-term maintenance is **MEDIUM** (kernel changes rare, API stable since 2002)
> 5. Tradeoff: We sacrifice **cross-platform support** to gain **minimal dependencies and low latency**

---

## Self-Check Quiz

### Question 1
**Why can't you have low latency + simple code + cross-platform?**

A) Technical limitation  
B) Inherent tradeoff in audio architecture  
C) Missing standards  
D) Vendor lock-in  

<details>
<summary>Answer</summary>

**B) Inherent tradeoff**

- Low latency: Direct hardware access (platform-specific)
- Simple code: High-level API (adds latency overhead)
- Cross-platform: Abstraction layer (adds complexity)

You must choose priorities!
</details>

---

### Question 2
**For a web-based game, which backend is WRONG?**

A) Web Audio API  
B) Emscripten + SDL2  
C) ALSA  
D) AudioWorklet  

<details>
<summary>Answer</summary>

**C) ALSA**

ALSA is Linux-native, doesn't run in browsers (no kernel access).

Web Audio or Emscripten-compiled SDL2 are correct choices.
</details>

---

### Question 3
**When should you write a custom audio abstraction layer?**

A) Always (best practice)  
B) When existing libraries don't meet requirements  
C) Never (use libraries)  
D) Only for commercial projects  

<details>
<summary>Answer</summary>

**B) When existing libraries don't meet requirements**

Writing abstractions is expensive. Only do it if:
- Need < 5ms latency (SDL2 can't deliver)
- Minimal binary size (libraries too large)
- Specific platform not supported

Otherwise, use SDL2/OpenAL/FMOD.
</details>

---

## Key Takeaways

### Decision Checklist

1. **Define requirements** (latency, platforms, team size)
2. **Score backends** (use matrix above)
3. **Prototype** top 2 choices (measure actual latency)
4. **Evaluate maintenance** (API stability, community)
5. **Document decision** (for future reference)

---

### Common Mistakes

❌ **"I'll make it cross-platform later"**  
→ Refactoring is 10x harder than abstraction from day 1

❌ **"I need < 1ms latency"**  
→ Most games work fine with 20-50ms (measure first!)

❌ **"I'll write my own audio library"**  
→ Only if you have a team and years (use SDL2/OpenAL)

---

### The One-Line Decision

**If unsure: Use SDL2 Audio.**

It handles 90% of game audio needs with minimal code.

---

## Next Lesson Preview

**L6.5: Real-World Debugging War Story**
- Audio worked on Ubuntu 20.04, broke on 22.04
- Investigating PulseAudio vs ALSA conflicts
- How to debug "no sound" issues
- Post-mortem analysis

---

**Estimated Completion Time:** 45-60 minutes  
**Difficulty:** ⭐⭐⭐⭐☆ (Advanced)  
**Competence Level Achieved:** 6/6 (Evaluation)

**Progress:** Unit 6 is 80% complete! (4/5 lessons done)

