# L6.5: Real-World Debugging War Story - When Audio Breaks

**Unit 6: Porting & Alternative Backends**  
**Estimated Time:** 60-75 minutes  
**Competence Target:** Level 6 (Evaluation - forensic analysis)

---

## Learning Objectives

By the end of this lesson, you will:

1. **Diagnose** "no sound" issues systematically
2. **Investigate** PulseAudio vs ALSA conflicts
3. **Analyze** OS upgrade breakage (Ubuntu 20.04 ‚Üí 22.04)
4. **Apply** debugging methodology to real failures
5. **Document** post-mortem analysis
6. **Prevent** similar issues in future projects

---

## The War Story: "It Worked Yesterday!"

### The Setup

**Your environment:**
- Ubuntu 20.04 LTS
- ALSA-based game (your code from Unit 1-5)
- Audio works perfectly for 6 months

**The incident:**
- Upgrade to Ubuntu 22.04 LTS
- Recompile game (no source changes)
- **No audio output!**
- No error messages
- Game runs normally otherwise

**Initial panic:** "Did I break something? Is my code wrong?"

---

## Phase 1: Confirm the Failure

### Step 1: Verify Hardware

```bash
# Test speaker hardware
speaker-test -t wav -c 2

# Expected: "Front Left... Front Right..."
# Actual: ‚úÖ Works! (Hardware is fine)
```

**Conclusion:** Problem is software, not hardware.

---

### Step 2: Test System Audio

```bash
# Try ALSA directly
aplay /usr/share/sounds/alsa/Front_Center.wav

# Expected: Plays sound
# Actual: ‚ö†Ô∏è Error: "Device or resource busy"
```

**Red flag:** ALSA device is locked by something!

---

### Step 3: Check What's Using Audio

```bash
# List processes using sound card
lsof /dev/snd/*

# Output:
# COMMAND    PID  USER
# pulseaudio 1234 youruser
```

**Discovery:** PulseAudio is running (wasn't on 20.04 by default).

---

## Phase 2: Understand the Conflict

### Ubuntu Audio Stack Evolution

**Ubuntu 20.04:**
```
Your Game ‚Üí ALSA ‚Üí Hardware
```

**Ubuntu 22.04:**
```
Your Game ‚Üí ALSA ‚Üí ‚ùå BUSY
                ‚Üì
          PulseAudio ‚Üí ALSA ‚Üí Hardware
```

**Problem:** PulseAudio grabbed exclusive ALSA access!

---

### Why Did This Happen?

**Ubuntu 22.04 changes:**
1. PulseAudio enabled by default (systemd service)
2. ALSA `dmix` plugin not configured by default
3. Exclusive access mode (prevents mixing)

**Your code assumes:**
```c
snd_pcm_open(&handle, "default", SND_PCM_STREAM_PLAYBACK, 0);
```

**On 20.04:** `"default"` ‚Üí direct hardware  
**On 22.04:** `"default"` ‚Üí PulseAudio plugin (but you're not using PulseAudio API)

---

## Phase 3: Solutions (Ordered by Quality)

### Solution 1: Kill PulseAudio (WRONG)

```bash
killall pulseaudio
./game  # ‚úÖ Works now!
```

**Problems:**
- PulseAudio restarts automatically (systemd)
- Breaks other apps (Firefox, Spotify, etc.)
- Not user-friendly

**Verdict:** ‚ùå Temporary hack, not a fix.

---

### Solution 2: Use ALSA dmix Plugin (OK)

**Edit `/etc/asound.conf` or `~/.asoundrc`:**
```
pcm.!default {
  type plug
  slave.pcm "dmix"
}
```

**Then:**
```bash
./game  # ‚úÖ Works!
aplay test.wav  # ‚úÖ Also works simultaneously
```

**Why it works:** `dmix` provides software mixing for ALSA.

**Problems:**
- Requires user configuration
- Higher latency (software mixing)
- Not portable (needs config file)

**Verdict:** ‚ö†Ô∏è Works, but requires user action.

---

### Solution 3: Port to PulseAudio (GOOD)

**Use PulseAudio Simple API (from L6.2):**
```c
#include <pulse/simple.h>

pa_simple *s = pa_simple_new(
  NULL, "MyGame", PA_STREAM_PLAYBACK,
  NULL, "audio", &spec, NULL, NULL, NULL
);

pa_simple_write(s, samples, bytes, NULL);
```

**Benefits:**
- Works on Ubuntu 22.04+ out of the box
- Automatically mixes with other apps
- No user configuration

**Tradeoff:** Higher latency (50-80ms vs 20-40ms ALSA).

**Verdict:** ‚úÖ Recommended for desktop games.

---

### Solution 4: Runtime Detection (BEST)

**Detect and adapt:**
```c
typedef struct AudioBackend {
  int (*init)(int sample_rate);
  void (*write)(void *samples, int count);
  void (*shutdown)();
} AudioBackend;

AudioBackend *InitAudio() {
  // Try PulseAudio first
  if (TryInitPulseAudio()) {
    printf("Using PulseAudio\n");
    return &pulse_backend;
  }
  
  // Fallback to ALSA
  if (TryInitALSA()) {
    printf("Using ALSA\n");
    return &alsa_backend;
  }
  
  fprintf(stderr, "No audio backend available\n");
  return NULL;
}
```

**Benefits:**
- Works on both old and new Ubuntu
- No user configuration
- Graceful degradation

**Verdict:** ‚úÖ Best for production code.

---

## Phase 4: Post-Mortem Analysis

### What Went Wrong?

1. **Assumption:** ALSA would always have direct hardware access
2. **Reality:** Desktop Linux moved to PulseAudio (2006-2022 transition)
3. **Root cause:** Didn't test on multiple distributions
4. **Missed warning:** No error checking on `snd_pcm_open()`

---

### What Should We Have Done?

**Before Ubuntu 22.04:**
```c
snd_pcm_t *handle;
int error = snd_pcm_open(&handle, "default", SND_PCM_STREAM_PLAYBACK, 0);

if (error < 0) {
  // ‚ùå No error handling!
}
```

**After (improved):**
```c
int error = snd_pcm_open(&handle, "default", SND_PCM_STREAM_PLAYBACK, 0);

if (error < 0) {
  fprintf(stderr, "ALSA init failed: %s\n", snd_strerror(error));
  fprintf(stderr, "Trying PulseAudio...\n");
  // Fallback to PulseAudio
}
```

**Lesson:** Always check return codes and provide fallbacks!

---

## Exercise 1: Reproduce the Issue

**Simulate Ubuntu 22.04 environment:**

```bash
# Start PulseAudio (if not running)
systemctl --user start pulseaudio

# Try your game
./game

# Expected: No sound or "Device busy" error
```

**Then apply Solution 4** (runtime detection).

---

## Exercise 2: Debug "No Sound" Systematically

**Checklist when audio fails:**

```bash
# 1. Hardware check
speaker-test -t wav -c 2

# 2. System audio check
aplay /usr/share/sounds/alsa/Front_Center.wav

# 3. Check what's using audio
lsof /dev/snd/* | grep -v PulseAudio

# 4. Check PulseAudio status
pactl info

# 5. Check ALSA devices
aplay -L | head -20

# 6. Check for muted channels
alsamixer  # Press F6 to select card, check volumes

# 7. Check application logs
./game 2>&1 | grep -i audio
```

**Work through this checklist for ANY audio issue!**

---

## Common "No Sound" Causes

### Issue 1: Wrong Device Name

**Your code:**
```c
snd_pcm_open(&handle, "default", ...);
```

**Try:**
```c
// List all devices first
snd_pcm_open(&handle, "hw:0,0", ...);  // First card, first device
snd_pcm_open(&handle, "plughw:0,0", ...);  // With format conversion
snd_pcm_open(&handle, "pulse", ...);  // Route through PulseAudio
```

---

### Issue 2: PulseAudio Locked Device

**Check:**
```bash
lsof /dev/snd/*
```

**Fix:**
- Use PulseAudio API, OR
- Configure dmix, OR
- Open with `SND_PCM_NONBLOCK` flag

---

### Issue 3: Muted Channel

**Check:**
```bash
amixer sget Master
# Output: [50%] [off]  ‚Üê Muted!
```

**Fix:**
```bash
amixer sset Master unmute
amixer sset Master 80%
```

---

### Issue 4: Wrong Sample Format

**Your code:**
```c
snd_pcm_hw_params_set_format(handle, params, SND_PCM_FORMAT_S16_LE);
```

**Error:** "Invalid argument" (hardware doesn't support S16_LE).

**Detect supported formats:**
```c
for (int fmt = 0; fmt <= SND_PCM_FORMAT_LAST; fmt++) {
  if (snd_pcm_hw_params_test_format(handle, params, fmt) == 0) {
    printf("Supported: %s\n", snd_pcm_format_name(fmt));
  }
}
```

---

### Issue 5: Buffer Size Too Small

**Error:** Frequent underruns (clicks/pops).

**Fix:** Increase buffer size:
```c
snd_pcm_uframes_t buffer_size = 2048;  // Try 4096, 8192
snd_pcm_hw_params_set_buffer_size_near(handle, params, &buffer_size);
```

---

## Debugging Tools Reference

### ALSA Tools

```bash
# List devices
aplay -L

# Test playback
speaker-test -c 2 -t wav

# Show hardware capabilities
aplay -D hw:0,0 --dump-hw-params /dev/null

# Monitor PCM stream
alsactl monitor
```

---

### PulseAudio Tools

```bash
# Server info
pactl info

# List sinks (output devices)
pactl list sinks

# List sources (input devices)
pactl list sources

# Set default sink
pactl set-default-sink alsa_output.pci-0000_00_1f.3.analog-stereo

# Volume control GUI
pavucontrol
```

---

### Generic Tools

```bash
# What's using audio?
lsof /dev/snd/*

# Kernel messages
dmesg | grep -i audio

# Check ALSA version
cat /proc/asound/version

# List sound cards
cat /proc/asound/cards
```

---

## Post-Mortem Template

**Use this for ANY production bug:**

```markdown
# Audio Failure Post-Mortem

## Summary
- **Date:** 2024-XX-XX
- **Impact:** No audio on Ubuntu 22.04+
- **Root Cause:** PulseAudio conflict
- **Resolution:** Runtime backend detection

## Timeline
- 10:00 - User reports "no sound"
- 10:15 - Reproduced on Ubuntu 22.04
- 10:30 - Identified PulseAudio as cause
- 11:00 - Implemented PulseAudio fallback
- 11:30 - Deployed fix

## What Went Wrong
1. Assumed ALSA direct access
2. No error handling on snd_pcm_open()
3. Didn't test on Ubuntu 22.04

## What Went Right
1. Hardware test isolated issue quickly
2. lsof revealed PulseAudio lock

## Action Items
- [ ] Add runtime backend detection
- [ ] Test on Fedora, Arch, Debian
- [ ] Add audio backend to CI tests
- [ ] Document audio requirements

## Lessons Learned
- Always check return codes
- Test on multiple distros
- Plan for audio stack evolution
```

---

## Self-Check Quiz

### Question 1
**Why did audio break on Ubuntu 22.04?**

A) ALSA was removed  
B) PulseAudio grabbed exclusive ALSA access  
C) Hardware changed  
D) Game code had a bug  

<details>
<summary>Answer</summary>

**B) PulseAudio grabbed exclusive ALSA access**

Ubuntu 22.04 enables PulseAudio by default, locking `/dev/snd/*` devices.
</details>

---

### Question 2
**What's the FIRST step when debugging "no sound"?**

A) Rewrite audio code  
B) Reinstall OS  
C) Test hardware with `speaker-test`  
D) Check PulseAudio logs  

<details>
<summary>Answer</summary>

**C) Test hardware with `speaker-test`**

Always eliminate hardware failure first!
</details>

---

### Question 3
**What's the best long-term fix for ALSA/PulseAudio conflicts?**

A) Kill PulseAudio  
B) Configure dmix  
C) Runtime backend detection  
D) Use Windows instead  

<details>
<summary>Answer</summary>

**C) Runtime backend detection**

Try PulseAudio first, fallback to ALSA. Works on all distros.
</details>

---

## Key Takeaways

### Debugging Methodology

1. **Isolate:** Hardware vs software vs code
2. **Investigate:** System state (lsof, pactl, etc.)
3. **Hypothesize:** What changed?
4. **Test:** Smallest possible change
5. **Document:** Post-mortem for future

---

### Audio Stack Fragility

**Linux audio has changed:**
- 2002-2010: OSS/ALSA chaos
- 2010-2020: PulseAudio transition
- 2020+: PipeWire emerging

**Your code must adapt or die!**

**Best practice:** Abstract early, test widely.

---

## Completion: Unit 6 Done! üéâ

**You've learned:**
- ‚úÖ Backend comparison (ALSA/PulseAudio/Web Audio)
- ‚úÖ PulseAudio Simple API
- ‚úÖ Web Audio porting
- ‚úÖ Tradeoff analysis
- ‚úÖ Real-world debugging

**Competence level:** 6/6 (Evaluation)  
You can now **critique and justify** audio architecture decisions!

---

## Final Exercise: Your Audio Roadmap

**Answer these:**

1. **Which backend(s) will you support?**
   - [ ] ALSA only
   - [ ] PulseAudio only
   - [ ] Runtime detection (ALSA + PulseAudio)
   - [ ] SDL2 abstraction
   - [ ] Other: _______

2. **What's your latency target?**
   - [ ] < 10ms (pro audio)
   - [ ] < 50ms (games)
   - [ ] < 200ms (acceptable)

3. **What platforms?**
   - [ ] Linux only
   - [ ] Linux + Windows + macOS
   - [ ] Web (browser)
   - [ ] Mobile (iOS/Android)

4. **Fallback strategy if audio fails?**
   - [ ] Crash (audio critical)
   - [ ] Silent mode (continue without audio)
   - [ ] Retry with different backend

**Document this in your project README!**

---

**Estimated Completion Time:** 60-75 minutes  
**Difficulty:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Expert)  
**Competence Level Achieved:** 6/6 (Evaluation)

---

**Progress:** Unit 6 is 100% COMPLETE! üéä  
**Units 4-6 FULLY COMPLETE!**

---

## Next Steps

You've completed the advanced audio curriculum (Units 4-6)!

**Continue learning:**
- Unit 7: Real-Time Systems (scheduling, priorities)
- Unit 8: Performance Optimization (SIMD, lock-free)
- Unit 9: Advanced Features (WAV loading, mixers)

**Or apply your knowledge:**
- Port your game to PulseAudio
- Add Web Audio support
- Write a post-mortem on your audio bugs
- Teach someone else!

**You now OWN the audio stack. No more cargo-culting!** üöÄ

