# L10.9: Spatial Audio (ECS Pattern)

## Core Concept

Entity-Component-System for sound sources. No inheritance, just arrays of components.

## ECS Implementation

```javascript
/** Component arrays */
const MAX_SOUNDS = 256;

const sounds = {
  activeCount: 0,
  positions: new Float32Array(MAX_SOUNDS * 3), // x, y, z
  samples: new Array(MAX_SOUNDS),
  playheads: new u32Array(MAX_SOUNDS),
  priorities: new u8Array(MAX_SOUNDS),
};

/**
 * Spawn sound at position
 */
export function spawnSound(sampleData, x, y, z, priority = 5) {
  if (sounds.activeCount >= MAX_SOUNDS) return -1;

  const index = sounds.activeCount++;
  sounds.positions[index * 3] = x;
  sounds.positions[index * 3 + 1] = y;
  sounds.positions[index * 3 + 2] = z;
  sounds.samples[index] = sampleData;
  sounds.playheads[index] = 0;
  sounds.priorities[index] = priority;

  return index;
}

/**
 * Mix all sounds with 3D attenuation
 */
export function mixSounds(outputBuffer, listenerX, listenerY, listenerZ) {
  outputBuffer.fill(0);

  for (let i = 0; i < sounds.activeCount; i++) {
    const x = sounds.positions[i * 3];
    const y = sounds.positions[i * 3 + 1];
    const z = sounds.positions[i * 3 + 2];

    // Distance attenuation
    const dx = x - listenerX;
    const dy = y - listenerY;
    const dz = z - listenerZ;
    const distance = Math.sqrt(dx * dx + dy * dy + dz * dz);
    const attenuation = 1.0 / (1.0 + distance);

    // Mix sample
    const sample = sounds.samples[i];
    const playhead = sounds.playheads[i];

    for (
      let j = 0;
      j < outputBuffer.length && playhead + j < sample.length;
      j++
    ) {
      outputBuffer[j] += sample[playhead + j] * attenuation;
    }

    sounds.playheads[i] += outputBuffer.length;
  }

  // Remove finished sounds
  cullFinishedSounds();
}
```

**Key Principle:** Components are **flat arrays**, not objects with methods.

**Next: L10.10 - Full Game Integration**
