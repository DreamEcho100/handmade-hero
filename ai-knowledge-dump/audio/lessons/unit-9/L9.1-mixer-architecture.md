# L9.1: Mixer Architecture - Multiple Sound Sources

**Unit 9: Game Audio Architecture Patterns**  
**Estimated Time:** 90-120 minutes  
**Competence Target:** Level 5 (Synthesis - can design game audio systems)

---

## Learning Objectives

1. **Design** multi-source audio mixer
2. **Prevent** clipping when mixing signals
3. **Implement** per-source volume control
4. **Manage** sound lifetimes (play/stop/loop)
5. **Optimize** mixer performance
6. **Understand** mixing algorithms (sum vs average)

---

## The Challenge: Play 3 Sounds Simultaneously

**Current:** 1 sine wave at a time  
**Goal:** Background music + footsteps + gunshot

---

## Concept 1: Naive Mixing (Causes Clipping!)

```c
// BAD: Direct sum (causes clipping)
void MixBad(int16_t *output, int16_t *music, int16_t *sfx1, int16_t *sfx2, int count) {
  for (int i = 0; i < count; i++) {
    output[i] = music[i] + sfx1[i] + sfx2[i];  // Can overflow int16_t!
  }
}

// If music[i] = 20000, sfx1[i] = 20000, sfx2[i] = 20000
// Sum = 60000 → Wraps to -5536 (clipping distortion!)
```

---

## Concept 2: Proper Mixing (Average or Clamp)

### Method 1: Average (Safe but Quiet)

```c
void MixAverage(int16_t *output, int16_t *music, int16_t *sfx1, int16_t *sfx2, int count) {
  for (int i = 0; i < count; i++) {
    int32_t sum = (int32_t)music[i] + sfx1[i] + sfx2[i];
    output[i] = (int16_t)(sum / 3);  // Average
  }
}
```

**Pro:** Never clips  
**Con:** Quieter than individual sounds

---

### Method 2: Soft Clipping (Realistic)

```c
inline int16_t Clamp(int32_t value) {
  if (value > 32767) return 32767;
  if (value < -32768) return -32768;
  return (int16_t)value;
}

void MixClamp(int16_t *output, int16_t *music, int16_t *sfx1, int16_t *sfx2, int count) {
  for (int i = 0; i < count; i++) {
    int32_t sum = (int32_t)music[i] + sfx1[i] + sfx2[i];
    output[i] = Clamp(sum);
  }
}
```

**Pro:** Preserves loudness  
**Con:** Distorts when too loud (acceptable for games)

---

## Concept 3: Dynamic Source Management

```c
#define MAX_SOUNDS 32

typedef struct {
  int16_t *samples;    // Sound data
  int length;          // Total samples
  int position;        // Current playback position
  float volume;        // 0.0 to 1.0
  bool looping;
  bool active;
} SoundSource;

typedef struct {
  SoundSource sources[MAX_SOUNDS];
  int active_count;
} AudioMixer;

void AudioMixer_Play(AudioMixer *mixer, int16_t *samples, int length, float volume, bool loop) {
  // Find free slot
  for (int i = 0; i < MAX_SOUNDS; i++) {
    if (!mixer->sources[i].active) {
      mixer->sources[i].samples = samples;
      mixer->sources[i].length = length;
      mixer->sources[i].position = 0;
      mixer->sources[i].volume = volume;
      mixer->sources[i].looping = loop;
      mixer->sources[i].active = true;
      mixer->active_count++;
      return;
    }
  }
}

void AudioMixer_Mix(AudioMixer *mixer, int16_t *output, int count) {
  memset(output, 0, count * sizeof(int16_t));
  
  for (int s = 0; s < MAX_SOUNDS; s++) {
    SoundSource *src = &mixer->sources[s];
    if (!src->active) continue;
    
    for (int i = 0; i < count; i++) {
      if (src->position >= src->length) {
        if (src->looping) {
          src->position = 0;
        } else {
          src->active = false;
          mixer->active_count--;
          break;
        }
      }
      
      int32_t sample = (int32_t)(src->samples[src->position] * src->volume);
      int32_t mixed = output[i] + sample;
      output[i] = Clamp(mixed);
      
      src->position++;
    }
  }
}
```

---

## Exercise: Implement Game Mixer

**Features:**
- Play background music (loop)
- Play footsteps (one-shot)
- Play gunshot (one-shot, loud)

```c
AudioMixer mixer = {0};

// Startup
AudioMixer_Play(&mixer, music_samples, music_length, 0.5f, true);   // Loop

// In game loop
if (player_walking) {
  AudioMixer_Play(&mixer, footstep_samples, footstep_length, 0.3f, false);
}

if (player_shoot) {
  AudioMixer_Play(&mixer, gunshot_samples, gunshot_length, 0.8f, false);
}

// Audio callback
AudioMixer_Mix(&mixer, output_buffer, sample_count);
```

---

## Key Takeaways

**Mixing formulas:**
- Sum: `output = a + b + c` (can clip)
- Average: `output = (a + b + c) / 3` (safe, quiet)
- Clamp: `output = clamp(a + b + c)` (best for games)

**Architecture:**
- Fixed-size source array (MAX_SOUNDS)
- Per-source volume control
- Play/stop/loop management
- Lock-free from audio thread

---

**Estimated Completion Time:** 90-120 minutes  
**Difficulty:** ⭐⭐⭐⭐☆ (Advanced)  
**Progress:** Unit 9 is 33% complete! (1/3 lessons)
