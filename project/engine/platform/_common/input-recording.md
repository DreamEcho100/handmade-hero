# Input Recording Documentation

## Visual Timeline of Recording/Playback

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        COMPLETE TIMELINE EXAMPLE                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  TIME ──────────────────────────────────────────────────────────────────►   │
│                                                                             │
│  Frame:  0    10    20    30    40    50    60    70    80    90   100     │
│          │     │     │     │     │     │     │     │     │     │     │     │
│          ▼     ▼     ▼     ▼     ▼     ▼     ▼     ▼     ▼     ▼     ▼     │
│                                                                             │
│  ════════════════════════════════════════════════════════════════════════   │
│  PHASE 1: NORMAL GAMEPLAY                                                   │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Player:  ●────────────────────►                                            │
│           (moving right)                                                    │
│                                                                             │
│  State:   IDLE                                                              │
│                                                                             │
│  ════════════════════════════════════════════════════════════════════════   │
│  PHASE 2: USER PRESSES 'L' AT FRAME 30                                      │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                             │
│                      [L]                                                    │
│                       │                                                     │
│                       ▼                                                     │
│  Action:        SAVE GAME STATE TO FILE                                     │
│                 ┌─────────────────────────────────────────┐                 │
│                 │ File: recording_1.hmi                   │                 │
│                 │ ┌─────────────────────────────────────┐ │                 │
│                 │ │ GAME STATE (player at position 30) │ │                 │
│                 │ └─────────────────────────────────────┘ │                 │
│                 └─────────────────────────────────────────┘                 │
│                                                                             │
│  State:   IDLE ──► RECORDING                                                │
│                                                                             │
│  ════════════════════════════════════════════════════════════════════════   │
│  PHASE 3: RECORDING (Frames 30-60)                                          │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Player:                    ●────────────────────►                          │
│                             (user plays: right, jump, attack)               │
│                                                                             │
│  File grows:                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ GAME STATE │ Input30 │ Input31 │ Input32 │ ... │ Input59 │ Input60 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  State:   RECORDING                                                         │
│                                                                             │
│  ════════════════════════════════════════════════════════════════════════   │
│  PHASE 4: USER PRESSES 'L' AT FRAME 60                                      │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                             │
│                                              [L]                            │
│                                               │                             │
│                                               ▼                             │
│  Actions:  1. STOP RECORDING (close file)                                   │
│            2. RESTORE GAME STATE FROM FILE                                  │
│            3. START PLAYBACK                                                │
│                                                                             │
│  Player:                                     ●                              │
│                                              │                              │
│                                              ▼                              │
│                      ●  (teleported back to position 30!)                   │
│                                                                             │
│  State:   RECORDING ──► PLAYBACK                                            │
│                                                                             │
│  ════════════════════════════════════════════════════════════════════════   │
│  PHASE 5: PLAYBACK LOOP (Frames 60-90, then 90-120, etc.)                   │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Frame 60-90: Replay recorded inputs                                        │
│  Player:                    ●────────────────────►                          │
│                             (same movements as frames 30-60)                │
│                                                                             │
│  Frame 90: EOF reached!                                                     │
│            ┌──────────────────────────────────────────────────────┐        │
│            │ 1. Restore game state (player back to position 30)  │        │
│            │ 2. Seek file to first input                         │        │
│            │ 3. Continue playback                                 │        │
│            └──────────────────────────────────────────────────────┘        │
│                                                                             │
│  Frame 90-120: Replay again!                                                │
│  Player:                    ●────────────────────►                          │
│                             (same movements again)                          │
│                                                                             │
│  Frame 120: EOF reached! Loop again...                                      │
│                                                                             │
│  ════════════════════════════════════════════════════════════════════════   │
│  PHASE 6: LIVE CODE EDITING (while loop plays)                              │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  While the game loops:                                                      │
│                                                                             │
` change player speed from 4.0 to 8.0                        │`

│  1. Edit game.c
│  2. Save file                                                               │
│  3. Compiler rebuilds game.so                                               │
│  4. Hot reload detects change, loads new code                               │
│  5. Next loop iteration uses NEW code!                                      │
│                                                                             │
│  Player:                    ●════════════════════════════►                  │
│                             (now moves FASTER with same inputs!)            │
│                                                                             │
│  ════════════════════════════════════════════════════════════════════════   │
│  PHASE 7: USER PRESSES 'L' TO STOP                                          │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                             │
│                                                              [L]            │
│                                                               │             │
│                                                               ▼             │
│  Action:  STOP PLAYBACK                                                     │
│                                                                             │
│  State:   PLAYBACK ──► IDLE                                                 │
│                                                                             │
│  Game continues normally from wherever it was in the loop.                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Memory Layout Deep Dive

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        MEMORY LAYOUT                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  GAME MEMORY (allocated at startup, never freed)                            │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Address: 0x0000020000000000 (2 TB mark in debug builds)                    │
│           │                                                                 │
│           ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  PERMANENT STORAGE (64 MB)                                          │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  GameState struct:                                          │   │   │
│  │  │  ├── player_x: 150                                          │   │   │
│  │  │  ├── player_y: 200                                          │   │   │
│  │  │  ├── health: 100                                            │   │   │
│  │  │  ├── score: 5000                                            │   │   │
│  │  │  ├── tone_hz: 512                                           │   │   │
│  │  │  ├── t_sine: 0.785                                          │   │   │
│  │  │  └── ... other game state ...                               │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │  TRANSIENT STORAGE (1 GB)                                           │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  Loaded assets, scratch memory, temporary data              │   │   │
│  │  │  (This gets saved/restored too!)                            │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Total: 64 MB + 1 GB = 1,073,741,824 + 67,108,864 = 1,140,850,688 bytes    │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  RECORDING FILE (on disk)                                                   │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  File: recording_1.hmi                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  Bytes 0 - 1,140,850,687:                                          │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  GAME STATE SNAPSHOT                                        │   │   │
│  │  │  (exact copy of game memory at recording start)             │   │   │
│  │  │                                                             │   │   │
│  │  │  player_x: 150                                              │   │   │
│  │  │  player_y: 200                                              │   │   │
│  │  │  health: 100                                                │   │   │
│  │  │  ...                                                        │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  Bytes 1,140,850,688 - 1,140,850,687 + sizeof(GameInput):          │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  INPUT FRAME 0                                              │   │   │
│  │  │  controllers[0].move_right.ended_down = true                │   │   │
│  │  │  controllers[0].stick_avg_x = 0.75                          │   │   │
│  │  │  ...                                                        │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  Next sizeof(GameInput) bytes:                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  INPUT FRAME 1                                              │   │   │
│  │  │  controllers[0].action_down.ended_down = true (jump!)       │   │   │
│  │  │  ...                                                        │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  ... more input frames ...                                         │   │
│  │                                                                     │   │
│  │  Last sizeof(GameInput) bytes:                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  INPUT FRAME N                                              │   │   │
│  │  │  (last frame before user pressed L again)                   │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  File size = 1,140,850,688 + (N × sizeof(GameInput)) bytes                 │
│                                                                             │
│  Example: 30 frames at 30 FPS = 1 second of recording                       │
│           sizeof(GameInput) ≈ 500 bytes (rough estimate)                    │
│           File size ≈ 1.06 GB + 15 KB = ~1.06 GB                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## File I/O Byte-by-Byte

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        FILE I/O BYTE-BY-BYTE                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  STEP 1: OPEN FILE FOR WRITING                                              │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Code: int fd = open("recording_1.hmi", O_WRONLY | O_CREAT | O_TRUNC, 0644) │
│                                                                             │
│  What happens:                                                              │
│                                                                             │
│  1. Kernel looks up "recording_1.hmi" in filesystem                         │
│  2. If exists: truncate to 0 bytes (O_TRUNC)                                │
│  3. If not exists: create new file (O_CREAT)                                │
│  4. Allocate file descriptor in process table                               │
│  5. Return fd (e.g., 3)                                                     │
│                                                                             │
│  Process FD Table:          Kernel File Table:                              │
│  ┌────┬─────────┐           ┌─────────────────────────────────┐            │
│  │ 0  │ stdin   │           │ recording_1.hmi                 │            │
│  │ 1  │ stdout  │           │ ├── position: 0                 │            │
│  │ 2  │ stderr  │           │ ├── size: 0                     │            │
│  │ 3  │ ────────┼──────────►│ └── mode: write-only            │            │
│  └────┴─────────┘           └─────────────────────────────────┘            │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  STEP 2: WRITE GAME STATE                                                   │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Code: write(fd, game_memory_base, total_size)                              │
│        // total_size = 1,140,850,688 bytes (~1.06 GB)                       │
│                                                                             │
│  What happens (simplified):                                                 │
│                                                                             │
│  Memory:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ game_memory_base                                                    │   │
│  │ ▼                                                                   │   │
│  │ [B0][B1][B2][B3][B4][B5]...[B1140850687]                            │   │
│  │  │   │   │   │   │   │         │                                    │   │
│  └──┼───┼───┼───┼───┼───┼─────────┼────────────────────────────────────┘   │
│     │   │   │   │   │   │         │                                        │
│     ▼   ▼   ▼   ▼   ▼   ▼         ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Kernel Buffer (copied from user space)                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│     │                                                                       │
│     ▼                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Disk: recording_1.hmi                                               │   │
│  │ [B0][B1][B2][B3][B4][B5]...[B1140850687]                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  After write:                                                               │
│  - File size: 1,140,850,688 bytes                                          │
│  - File position: 1,140,850,688 (at end)                                   │
│  - Returns: 1,140,850,688 (bytes written)                                  │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  STEP 3: WRITE INPUT FRAMES (each frame)                                    │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Code: write(fd, input, sizeof(GameInput))                                  │
│        // sizeof(GameInput) ≈ 500 bytes                                     │
│                                                                             │
│  Frame 0:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ File before:                                                        │   │
│  │ [GAME STATE (1.06 GB)]                                              │   │
│  │                       ▲                                              │   │
│  │                       └── position                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ File after:                                                         │   │
│  │ [GAME STATE (1.06 GB)][INPUT 0 (500 B)]                             │   │
│  │                                        ▲                             │   │
│  │                                        └── position                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Frame 1:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [GAME STATE][INPUT 0][INPUT 1]                                      │   │
│  │                               ▲                                      │   │
│  │                               └── position                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Frame N:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [GAME STATE][INPUT 0][INPUT 1]...[INPUT N]                          │   │
│  │                                           ▲                          │   │
│  │                                           └── position (EOF)         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  STEP 4: CLOSE FILE                                                         │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Code: close(fd)                                                            │
│                                                                             │
│  What happens:                                                              │
│  1. Flush any buffered data to disk                                         │
│  2. Release file descriptor                                                 │
│  3. fd is now invalid (can be reused by kernel)                            │
│                                                                             │
│  Process FD Table:                                                          │
│  ┌────┬─────────┐                                                          │
│  │ 0  │ stdin   │                                                          │
│  │ 1  │ stdout  │                                                          │
│  │ 2  │ stderr  │                                                          │
│  │ 3  │ (free)  │  ◄── No longer points to file                            │
│  └────┴─────────┘                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Playback File I/O

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        PLAYBACK FILE I/O                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  STEP 1: OPEN FILE FOR READING                                              │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Code: int fd = open("recording_1.hmi", O_RDONLY)                           │
│                                                                             │
│  File state:                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [GAME STATE][INPUT 0][INPUT 1][INPUT 2]...[INPUT N]                 │   │
│  │ ▲                                                                    │   │
│  │ └── position = 0                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  STEP 2: READ GAME STATE (restore)                                          │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Code: read(fd, game_memory_base, total_size)                               │
│                                                                             │
│  What happens:                                                              │
│                                                                             │
│  File:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [GAME STATE (1.06 GB)][INPUT 0][INPUT 1]...[INPUT N]                │   │
│  │ ├────────────────────┤                                               │   │
│  │ │ Read these bytes   │                                               │   │
│  │ └────────────────────┘                                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                         │                                                   │
│                         ▼                                                   │
│  Game Memory:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ BEFORE: [CURRENT STATE - player at X=500, health=50]                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                         │                                                   │
│                         ▼ OVERWRITTEN!                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ AFTER:  [SAVED STATE - player at X=150, health=100]                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  File position after read:                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [GAME STATE][INPUT 0][INPUT 1][INPUT 2]...[INPUT N]                 │   │
│  │             ▲                                                        │   │
│  │             └── position (ready to read inputs)                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  STEP 3: READ INPUT FRAMES (each frame)                                     │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Code: bytes_read = read(fd, input, sizeof(GameInput))                      │
│                                                                             │
│  Frame 0:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [GAME STATE][INPUT 0][INPUT 1][INPUT 2]...[INPUT N]                 │   │
│  │             ├───────┤                                                │   │
│  │             │ Read  │                                                │   │
│  │             └───────┘                                                │   │
│  │                      ▲                                               │   │
│  │                      └── new position                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  bytes_read = sizeof(GameInput) ✓                                          │
│                                                                             │
│  Frame 1:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [GAME STATE][INPUT 0][INPUT 1][INPUT 2]...[INPUT N]                 │   │
│  │                      ├───────┤                                       │   │
│  │                      │ Read  │                                       │   │
│  │                      └───────┘                                       │   │
│  │                               ▲                                      │   │
│  │                               └── new position                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  bytes_read = sizeof(GameInput) ✓                                          │
│                                                                             │
│  ... continues until ...                                                    │
│                                                                             │
│  Frame N (last frame):                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [GAME STATE][INPUT 0][INPUT 1][INPUT 2]...[INPUT N]                 │   │
│  │                                           ├───────┤                  │   │
│  │                                           │ Read  │                  │   │
│  │                                           └───────┘                  │   │
│  │                                                    ▲                 │   │
│  │                                                    └── position=EOF  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  bytes_read = sizeof(GameInput) ✓                                          │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  STEP 4: EOF DETECTED (next read attempt)                                   │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Code: bytes_read = read(fd, input, sizeof(GameInput))                      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [GAME STATE][INPUT 0][INPUT 1][INPUT 2]...[INPUT N]│                │   │
│  │                                                    ▲│               │   │
│  │                                                    └┼── EOF         │   │
│  │                                                     │               │   │
│  │                                          Nothing to read!           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  bytes_read = 0  ◄── This is how we detect end of recording!               │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  STEP 5: LOOP (when EOF detected)                                           │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  When bytes_read == 0:                                                      │
│                                                                             │
│  1. Close file:  close(fd)                                                  │
│                                                                             │
│  2. Reopen file: fd = open("recording_1.hmi", O_RDONLY)                     │
│     ┌─────────────────────────────────────────────────────────────────┐    │
│     │ [GAME STATE][INPUT 0][INPUT 1]...[INPUT N]                      │    │
│     │ ▲                                                                │    │
│     │ └── position = 0 (back to start!)                                │    │
│     └─────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  3. Read game state: read(fd, game_memory_base, total_size)                 │
│     - Game memory restored to saved state                                   │
│     - Player teleports back to starting position                            │
│     ┌─────────────────────────────────────────────────────────────────┐    │
│     │ [GAME STATE][INPUT 0][INPUT 1]...[INPUT N]                      │    │
│     │             ▲                                                    │    │
│     │             └── position (ready for inputs again)                │    │
│     └─────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  4. Read first input: read(fd, input, sizeof(GameInput))                    │
│     - Now playing from beginning again!                                     │
│                                                                             │
│  This creates the INFINITE LOOP for live code editing!                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Complete Code Summary

### Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        COMPLETE DATA FLOW                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         MAIN LOOP                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  1. PREPARE INPUT FRAME                                             │   │
│  │     prepare_input_frame(old_input, new_input)                       │   │
│  │     - Copy ended_down states                                        │   │
│  │     - Reset half_transition_counts                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  2. GET INPUT                                                       │   │
│  │                                                                     │   │
│  │     ┌──────────────────┐     ┌──────────────────┐                  │   │
│  │     │ PLAYBACK MODE?   │────►│ YES: Read from   │                  │   │
│  │     │                  │     │ file             │                  │   │
│  │     └────────┬─────────┘     │                  │                  │   │
│  │              │ NO            │ playback_get_    │                  │   │
│  │              ▼               │ input(state,     │                  │   │
│  │     ┌──────────────────┐     │ new_input)       │                  │   │
│  │     │ Poll hardware:   │     └──────────────────┘                  │   │
│  │     │ - Keyboard       │              │                            │   │
│  │     │ - Joystick       │              │                            │   │
│  │     │ - Mouse          │              │                            │   │
│  │     └────────┬─────────┘              │                            │   │
│  │              │                        │                            │   │
│  │              ▼                        │                            │   │
│  │     ┌──────────────────┐              │                            │   │
│  │     │ RECORDING MODE?  │              │                            │   │
│  │     │                  │              │                            │   │
│  │     └────────┬─────────┘              │                            │   │
│  │              │ YES                    │                            │   │
│  │              ▼                        │                            │   │
│  │     ┌──────────────────┐              │                            │   │
│  │     │ Write to file:   │              │                            │   │
│  │     │ recording_record │              │                            │   │
│  │     │ _input(state,    │              │                            │   │
│  │     │ new_input)       │              │                            │   │
│  │     └──────────────────┘              │                            │   │
│  │              │                        │                            │   │
│  │              └────────────────────────┘                            │   │
│  │                         │                                          │   │
│  └─────────────────────────┼──────────────────────────────────────────┘   │
│                            ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  3. GAME UPDATE                                                     │   │
│  │     game.update_and_render(&memory, new_input, &backbuffer)         │   │
│  │                                                                     │   │
│  │     - Uses new_input (either real or recorded)                      │   │
│  │     - Updates game state in memory                                  │   │
│  │     - Renders to backbuffer                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                            │                                               │
│                            ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  4. AUDIO                                                           │   │
│  │     game.get_audio_samples(&memory, &audio_buffer)                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                            │                                               │
│                            ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  5. DISPLAY                                                         │   │
│  │     opengl_display_buffer(&backbuffer)                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                            │                                               │
│                            ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  6. SWAP INPUTS                                                     │   │
│  │     temp = new_input                                                │   │
│  │     new_input = old_input                                           │   │
│  │     old_input = temp                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                            │                                               │
│                            ▼                                               │
│                      NEXT FRAME                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Key Insights

### Why This Works

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        KEY INSIGHTS                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. DETERMINISM                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  If you give the game:                                                      │
│    - Same starting state                                                    │
│    - Same sequence of inputs                                                │
│                                                                             │
│  You get:                                                                   │
│    - Same exact behavior every time!                                        │
│                                                                             │
│  This is why recording/playback works:                                      │
│    State₀ + Input₀ → State₁                                                 │
│    State₁ + Input₁ → State₂                                                 │
│    State₂ + Input₂ → State₃                                                 │
│    ...                                                                      │
│                                                                             │
│  Same inputs + same starting state = same results                           │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  2. MEMORY AS A SNAPSHOT                                                    │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Game state is JUST BYTES in memory.                                        │
│                                                                             │
│  To save:  Copy bytes from memory → file                                    │
│  To load:  Copy bytes from file → memory                                    │
│                                                                             │
│  No serialization needed! No parsing! Just raw bytes.                       │
│                                                                             │
│  ┌────────────────────┐         ┌────────────────────┐                     │
│  │ Memory             │ ──────► │ File               │                     │
│  │ [raw bytes]        │  write  │ [same raw bytes]   │                     │
│  └────────────────────┘         └────────────────────┘                     │
│                                                                             │
│  ┌────────────────────┐         ┌────────────────────┐                     │
│  │ Memory             │ ◄────── │ File               │                     │
│  │ [restored bytes]   │  read   │ [saved bytes]      │                     │
│  └────────────────────┘         └────────────────────┘                     │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  3. FILE POSITION IS AUTOMATIC                                              │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Every read/write advances the file position automatically.                 │
│                                                                             │
│  write(fd, data, 100)  →  position += 100                                   │
│  read(fd, buf, 100)    →  position += 100                                   │
│                                                                             │
│  We don't need to manually track where we are in the file!                  │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  4. EOF DETECTION                                                           │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  read() returns 0 when there's nothing left to read.                        │
│                                                                             │
│  This is NOT an error - it's how we know we've reached the end.             │
│                                                                             │
│  bytes_read = read(fd, buf, 100);                                           │
│  if (bytes_read == 0) {                                                     │
│      // End of file - time to loop!                                         │
│  }                                                                          │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  5. WHY SLOTS?                                                              │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Slots let you have multiple recordings:                                    │
│                                                                             │
│  Slot 1: "recording_1.hmi" - Test jumping                                   │
│  Slot 2: "recording_2.hmi" - Test combat                                    │
│  Slot 3: "recording_3.hmi" - Test edge case                                 │
│                                                                             │
│  You could bind different keys to different slots:                          │
│    F1 → Slot 1                                                              │
│    F2 → Slot 2                                                              │
│    F3 → Slot 3                                                              │
│                                                                             │
│  For now, we just use slot 1 with the L key.                                │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│  6. LIVE CODE EDITING                                                       │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  The magic happens because:                                                 │
│                                                                             │
│  1. Game code is in a shared library (.so / .dll)                           │
│  2. Hot reload replaces the code while running                              │
│  3. Playback loop keeps running with NEW code                               │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Loop iteration 1: game.so v1 (player speed = 4)                     │   │
│  │ Loop iteration 2: game.so v1 (player speed = 4)                     │   │
│  │ Loop iteration 3: game.so v1 (player speed = 4)                     │   │
│  │                                                                     │   │
│  │ --- You edit code, change speed to 8, save ---                      │   │
│  │ --- Hot reload detects change, loads new .so ---                    │   │
│  │                                                                     │   │
│  │ Loop iteration 4: game.so v2 (player speed = 8) ◄── NEW CODE!       │   │
│  │ Loop iteration 5: game.so v2 (player speed = 8)                     │   │
│  │ Loop iteration 6: game.so v2 (player speed = 8)                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Same inputs, different code = different behavior!                          │
│  You can SEE your changes immediately without restarting.                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---
